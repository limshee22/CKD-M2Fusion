# CKD‑M2Fusion: Multi‑Modal Transformer Framework for Chronic Kidney Disease Staging via Serum Creatinine Regression

CKD‑M2Fusion combines *structured clinical data* with *kidney‑focused CT images* to jointly predict baseline serum creatinine (baseline_cr) and automatically assign Chronic Kidney Disease (CKD) stages.  
The framework fuses **TabPFN** embeddings of handcrafted clinic/kidney features with **Radiology‑Fortified DINOv2 ViT‑Base** image representations, enabling end‑to‑end multi‑modal learning that is data‑efficient and readily extensible.

---

### 🔧 Model Overview
1. **Kidney CT Branch**
   - Performs kidney segmentation on axial CT slices, producing binary masks.  
   - Retains only slices containing kidney tissue (mask > 0).  
   - Each selected slice is passed through a DINOv2 ViT‑Base encoder fine‑tuned on our dataset (weights initialized from AMOS‑pretrained model).

2. **Clinical Tabular Branch**
   - Hand‑crafted demographic, laboratory, and kidney‑specific variables are fed into a **TabPFN** transformer encoder.  
   - TabPFN is trained in a few‑shot fashion to embed tabular features into a latent vector.

3. **Feature Fusion & Prediction**
   - Slice‑wise visual features are concatenated (or mean‑pooled) to form a single visual descriptor per patient.  
   - The visual descriptor is concatenated with the TabPFN clinical embedding.  
   - A lightweight MLP head outputs:
     1. **Regression:** baseline_cr (mg/dL)  
     2. **Classification:** CKD stage (KDIGO 1‑5) via thresholded eGFR or direct softmax

---

### ⚙️ Key Features
1. **Dual Pre‑trained Backbones**  
   - *DINOv2 ViT‑Base* initialized from AMOS weights for robust medical imaging performance.  
   - *TabPFN* leverages large‑scale synthetic pre‑training for rapid convergence on small clinical datasets.

2. **Segmentation‑Aware Slice Selection**  
   - Automatically filters out non‑kidney slices, reducing noise and computation.

3. **Customizable Slice Resampling**  
   - Optional resampling to a fixed number of slices per study ensures consistent input shapes.

4. **End‑to‑End Multi‑Modal Learning**  
   - Single optimizer updates both branches and the fusion head, preserving modality‑specific nuances while learning synergistic representations.

5. **Flexible Output Modes**  
   - Supports pure regression (baseline_cr), pure classification (CKD stage), or joint multitask training with weighted losses.

---

### 🧾 Dataloader Structure
| Component | Format | Description |
|-----------|--------|-------------|
| **Images** | `(B, S, H, W)` | `B`: batch, `S`: selected slices, `H×W`: 224×224 (after resample) |
| **Clinical Features** | `(B, F)` | `F`: number of handcrafted variables |
| **Targets** | `(B,)` / `(B, 1)` | baseline_cr |

1. Within each batch, CT slices are sorted by anatomical order.  
2. For every patient, *per‑slice* features `v₁…v_S` are extracted, concatenated → `V_patient`.  
3. Clinical embedding `C_patient` is generated by TabPFN.  
4. Final feature vector: `[V_patient ‖ C_patient]` → MLP → outputs.

---

### 📁 Example Workflow
```text
Batch 1:
- Patient A:
    · CT Slices: [slice_01 … slice_N]  ➜  ViT Features: [A1 … AN]
    · Clinical Features: tab_A
    · Fusion: concat([A1 … AN] , tab_A) ➜ MLP ➜ baseline_cr_A

- Patient B: ...


### Installation
```text
git clone https://github.com/limshee22/CKD-M2Fusion.git
pip install -r requirements.txt




