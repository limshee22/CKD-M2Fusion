# CKDâ€‘M2Fusion: Multiâ€‘Modal Transformer Framework for Chronic Kidney Disease Staging via Serum Creatinine Regression

CKDâ€‘M2Fusion combines *structured clinical data* with *kidneyâ€‘focused CT images* to jointly predict baseline serum creatinine (baseline_cr) and automatically assign Chronic Kidney Disease (CKD) stages.  
The framework fuses **TabPFN** embeddings of handcrafted clinic/kidney features with **Radiologyâ€‘Fortified DINOv2 ViTâ€‘Base** image representations, enabling endâ€‘toâ€‘end multiâ€‘modal learning that is dataâ€‘efficient and readily extensible.

---

### ğŸ”§ Model Overview
1. **Kidney CT Branch**
   - Performs kidney segmentation on axial CT slices, producing binary masks.  
   - Retains only slices containing kidney tissue (mask >â€¯0).  
   - Each selected slice is passed through a DINOv2 ViTâ€‘Base encoder fineâ€‘tuned on our dataset (weights initialized from AMOSâ€‘pretrained model).

2. **Clinical Tabular Branch**
   - Handâ€‘crafted demographic, laboratory, and kidneyâ€‘specific variables are fed into a **TabPFN** transformer encoder.  
   - TabPFN is trained in a fewâ€‘shot fashion to embed tabular features into a latent vector.

3. **Feature Fusion & Prediction**
   - Sliceâ€‘wise visual features are concatenated (or meanâ€‘pooled) to form a single visual descriptor per patient.  
   - The visual descriptor is concatenated with the TabPFN clinical embedding.  
   - A lightweight MLP head outputs:
     1. **Regression:** baseline_cr (mg/dL)  
     2. **Classification:** CKD stage (KDIGO 1â€‘5) via thresholded eGFR or direct softmax

---

### âš™ï¸ Key Features
1. **Dual Preâ€‘trained Backbones**  
   - *DINOv2 ViTâ€‘Base* initialized from AMOS weights for robust medical imaging performance.  
   - *TabPFN* leverages largeâ€‘scale synthetic preâ€‘training for rapid convergence on small clinical datasets.

2. **Segmentationâ€‘Aware Slice Selection**  
   - Automatically filters out nonâ€‘kidney slices, reducing noise and computation.

3. **Customizable Slice Resampling**  
   - Optional resampling to a fixed number of slices per study ensures consistent input shapes.

4. **Endâ€‘toâ€‘End Multiâ€‘Modal Learning**  
   - Single optimizer updates both branches and the fusion head, preserving modalityâ€‘specific nuances while learning synergistic representations.

5. **Flexible Output Modes**  
   - Supports pure regression (baseline_cr), pure classification (CKD stage), or joint multitask training with weighted losses.

---

### ğŸ§¾ Dataloader Structure
| Component | Format | Description |
|-----------|--------|-------------|
| **Images** | `(B,â€¯S,â€¯H,â€¯W)` | `B`: batch, `S`: selected slices, `HÃ—W`: 224Ã—224 (after resample) |
| **Clinical Features** | `(B,â€¯F)` | `F`: number of handcrafted variables |
| **Targets** | `(B,)` / `(B,â€¯1)` | baseline_cr |

1. Within each batch, CT slices are sorted by anatomical order.  
2. For every patient, *perâ€‘slice* features `vâ‚â€¦v_S` are extracted, concatenated â†’ `V_patient`.  
3. Clinical embedding `C_patient` is generated by TabPFN.  
4. Final feature vector: `[V_patient â€– C_patient]` â†’ MLP â†’ outputs.

---

### ğŸ“ Example Workflow
```text
Batch 1:
- Patient A:
    Â· CT Slices: [slice_01 â€¦ slice_N]  âœ  ViT Features: [A1 â€¦ AN]
    Â· Clinical Features: tab_A
    Â· Fusion: concat([A1 â€¦ AN] , tab_A) âœ MLP âœ baseline_cr_A

- Patient B: ...


### Installation
```text
git clone https://github.com/limshee22/CKD-M2Fusion.git
pip install -r requirements.txt




